#!/bin/sh
# Mira auto-download wrapper for Claude Code plugin marketplace installs.
# Downloads the mira binary on first invocation; execs immediately on subsequent runs.
# All output goes to stderr — MCP uses stdout for the JSON protocol.

set -e

MIRA_VERSION="0.6.5"
REPO="ConaryLabs/Mira"
MIRA_HOME="${HOME}/.mira"
BIN_DIR="${MIRA_HOME}/bin"
MIRA_EXE_EXT=""
case "$(uname -s)" in
    MINGW*|MSYS*|CYGWIN*) MIRA_EXE_EXT=".exe" ;;
esac
MIRA_BIN="${BIN_DIR}/mira${MIRA_EXE_EXT}"
VERSION_FILE="${BIN_DIR}/.mira-version"

# --- Fast path: binary exists and version matches ---
if [ -x "$MIRA_BIN" ] && [ -f "$VERSION_FILE" ] && [ "$(cat "$VERSION_FILE")" = "$MIRA_VERSION" ]; then
    exec "$MIRA_BIN" "$@"
fi

# --- Slow path: download or update binary ---
log() { printf '%s\n' "$1" >&2; }

log "[mira-wrapper] Mira v${MIRA_VERSION} not found at ${MIRA_BIN} — downloading..."

# Detect platform
detect_platform() {
    case "$(uname -s)" in
        Linux*)                    os="unknown-linux-gnu" ;;
        Darwin*)                   os="apple-darwin" ;;
        MINGW*|MSYS*|CYGWIN*)     os="pc-windows-msvc" ;;
        *)       log "[mira-wrapper] Unsupported OS: $(uname -s). Install manually: https://github.com/${REPO}"; exit 1 ;;
    esac

    case "$(uname -m)" in
        x86_64|amd64)   arch="x86_64" ;;
        arm64|aarch64)  arch="aarch64" ;;
        *) log "[mira-wrapper] Unsupported architecture: $(uname -m)"; exit 1 ;;
    esac

    printf '%s' "${arch}-${os}"
}

# Pick a download tool
fetch() {
    if command -v curl >/dev/null 2>&1; then
        curl -fsSL "$1"
    elif command -v wget >/dev/null 2>&1; then
        wget -qO- "$1"
    else
        log "[mira-wrapper] Neither curl nor wget found. Install one and retry."; exit 1
    fi
}

platform="$(detect_platform)"

# Use .zip for Windows, .tar.gz for everything else
case "$platform" in
    *windows*) archive_ext="zip" ;;
    *)         archive_ext="tar.gz" ;;
esac

url="https://github.com/${REPO}/releases/download/v${MIRA_VERSION}/mira-${platform}.${archive_ext}"

log "[mira-wrapper] Platform: ${platform}"
log "[mira-wrapper] Downloading from: ${url}"

# Create directories
mkdir -p "$BIN_DIR"

# Download and extract to a temp file, then atomically move into place
tmp_dir="$(mktemp -d)"
trap 'rm -rf "$tmp_dir"' EXIT

if [ "$archive_ext" = "zip" ]; then
    zip_file="${tmp_dir}/mira.zip"
    if command -v curl >/dev/null 2>&1; then
        curl -fsSL "$url" -o "$zip_file"
    elif command -v wget >/dev/null 2>&1; then
        wget -qO "$zip_file" "$url"
    else
        log "[mira-wrapper] Neither curl nor wget found. Install one and retry."; exit 1
    fi
    unzip -qo "$zip_file" -d "$tmp_dir"
else
    fetch "$url" | tar -xz -C "$tmp_dir"
fi

# Determine extracted binary name
src_bin="${tmp_dir}/mira${MIRA_EXE_EXT}"

# chmod not needed on Windows
if [ -z "$MIRA_EXE_EXT" ]; then
    chmod +x "$src_bin"
fi

# Atomic install — safe if multiple wrapper instances race
mv -f "$src_bin" "$MIRA_BIN"
printf '%s' "$MIRA_VERSION" > "$VERSION_FILE"

# Strip macOS quarantine attribute if present
case "$(uname -s)" in
    Darwin*) xattr -d com.apple.quarantine "$MIRA_BIN" 2>/dev/null || true ;;
esac

log "[mira-wrapper] Installed mira v${MIRA_VERSION} to ${MIRA_BIN}"
log "[mira-wrapper] To configure providers, run: ${MIRA_BIN} setup"
exec "$MIRA_BIN" "$@"
