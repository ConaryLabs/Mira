name: "Complex Operation - Multi-Step Dependencies"
description: "Test complex multi-step operations with dependencies and context retention"
tags: ["complex", "multi-step", "context", "e2e"]
timeout_seconds: 600

setup:
  create_dirs:
    - "src/models"
    - "tests"
    - "docs"
  create_files:
    - path: "src/models/user.rs"
      content: |
        /// User model representing a system user
        #[derive(Debug, Clone)]
        pub struct User {
            pub id: i64,
            pub name: String,
            pub email: String,
        }

        impl User {
            /// Creates a new User instance
            pub fn new(id: i64, name: String, email: String) -> Self {
                User { id, name, email }
            }

            /// Returns the user's ID
            pub fn get_id(&self) -> i64 {
                self.id
            }
        }
    - path: "src/models/mod.rs"
      content: |
        pub mod user;
        pub use user::User;
    - path: "src/lib.rs"
      content: |
        pub mod models;

steps:
  - name: "Step 1 - Analyze existing code structure"
    prompt: |
      IMMEDIATELY use the read_project_file tool to read src/models/user.rs.
      Then tell me what fields and methods the User struct has.

      Do NOT delegate this to a background session. Call the tool directly.
    timeout_seconds: 90
    assertions:
      - type: completed_successfully
      - type: tool_executed
        tool_name: read_project_file
        success: true
      - type: response_contains
        text: "id"
      - type: response_contains
        text: "name"
      - type: response_contains
        text: "email"

  - name: "Step 2 - Add new method based on analysis"
    prompt: |
      === EXECUTION MODE ACTIVATED ===

      Call edit_project_file tool to add a display_name method to src/models/user.rs.
      The method: pub fn display_name(&self) -> String { format!("{} <{}>", self.name, self.email) }
      Insert after get_id method.

      Do NOT delegate this to a background session.
    timeout_seconds: 120
    force_tool: edit_project_file
    assertions:
      - type: completed_successfully
      - type: tool_executed
        tool_name: edit_project_file
        success: true
      - type: file_contains
        path: "src/models/user.rs"
        text: "display_name"

  - name: "Step 3 - Create test file for the struct"
    prompt: |
      === EXECUTION MODE ACTIVATED ===

      Call write_project_file tool with:
      - path: "tests/user_test.rs"
      - content: Rust test file with #[test] functions for User::new, get_id, and display_name

      Do NOT delegate this to a background session.
    timeout_seconds: 120
    force_tool: write_project_file
    assertions:
      - type: completed_successfully
      - type: tool_executed
        tool_name: write_project_file
        success: true
      - type: file_exists
        path: "tests/user_test.rs"
      - type: file_contains
        path: "tests/user_test.rs"
        text: "#[test]"
      - type: file_contains
        path: "tests/user_test.rs"
        text: "display_name"

  - name: "Step 4 - Generate documentation"
    prompt: |
      === EXECUTION MODE ACTIVATED ===

      Call write_project_file tool with:
      - path: "docs/MODELS.md"
      - content: Markdown documentation of User struct (fields: id, name, email; methods: new, get_id, display_name)

      Do NOT delegate this to a background session.
    timeout_seconds: 90
    force_tool: write_project_file
    assertions:
      - type: completed_successfully
      - type: tool_executed
        tool_name: write_project_file
        success: true
      - type: file_exists
        path: "docs/MODELS.md"
      - type: file_contains
        path: "docs/MODELS.md"
        text: "User"
      - type: file_contains
        path: "docs/MODELS.md"
        text: "display_name"

  - name: "Step 5 - Verify workflow consistency"
    prompt: |
      IMMEDIATELY use the read_project_file tool to read src/models/user.rs, tests/user_test.rs, and docs/MODELS.md.
      Then confirm that display_name is implemented, tested, and documented.

      Do NOT delegate this to a background session. Call the tool directly.
    timeout_seconds: 90
    assertions:
      - type: completed_successfully
      - type: tool_executed
        tool_name: read_project_file
        success: true
      - type: response_contains
        text: "display_name"

cleanup:
  remove_project: true
